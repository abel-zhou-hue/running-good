<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="x5-orientation" content="portrait">
    <meta name="x5-fullscreen" content="true">
    <meta name="x5-page-mode" content="app">
    <title>è·‘æ­¥æ‰“å¡è®°å½•ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* å¾®ä¿¡æµè§ˆå™¨é€‚é…æ ·å¼ */
        .weui-fix {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        /* å¾®ä¿¡æµè§ˆå™¨å­—ä½“ä¼˜åŒ– */
        body.wechat {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        /* AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤ - ç›¸å…³æ ·å¼å·²æ¸…ç† */

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 5px solid #007bff;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
        }

        .section h2::before {
            content: "ğŸƒâ€";
            margin-right: 10px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #1e7e34);
        }

        .btn-danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #333;
        }

        .runner-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .runner-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #28a745;
            transition: transform 0.3s;
        }

        .runner-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .runner-card.incomplete {
            border-left-color: #dc3545;
        }

        .runner-card.warning {
            border-left-color: #ffc107;
        }

        .runner-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .runner-target {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            border-radius: 10px;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .week-stats {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-top: 15px;
        }

        .day-stat {
            text-align: center;
            padding: 8px 4px;
            border-radius: 5px;
            font-size: 0.8em;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
        }

        .day-stat.completed {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }

        .day-stat.incomplete {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .records-table th,
        .records-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .records-table th {
            background: #007bff;
            color: white;
            font-weight: bold;
        }

        .records-table tr:hover {
            background: #f8f9fa;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-top: 4px solid #007bff;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .penalty-info {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .penalty-info h3 {
            margin-bottom: 10px;
        }

        .hidden {
            display: none;
        }

        /* å·²ç§»é™¤å·¦å³åˆ†æ å¸ƒå±€ - ç•Œé¢ç®€åŒ– */

        /* æ¯å‘¨å†å²è®°å½•æ ·å¼ */
        .week-history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .week-history-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            border-left: 4px solid #007bff;
        }

        .week-history-card h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }

        .week-history-card .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .week-history-card .stat-label {
            color: #666;
            font-size: 14px;
        }

        .week-history-details {
            background: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .week-history-runner {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .week-history-runner:last-child {
            border-bottom: none;
        }

        .week-history-runner-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .week-history-runner-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .week-history-runner-stat {
            text-align: center;
        }

        .week-history-runner-stat .value {
            font-weight: bold;
            color: #007bff;
            font-size: 14px;
        }

        .week-history-runner-stat .label {
            font-size: 12px;
            color: #666;
        }

        .status-complete {
            color: #28a745;
        }

        .status-incomplete {
            color: #dc3545;
        }

        .divider {
            text-align: center;
            margin: 20px 0;
            color: #666;
            font-weight: bold;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
            z-index: 1;
        }

        .divider span {
            background: white;
            padding: 0 15px;
            position: relative;
            z-index: 2;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .runner-list {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .week-stats {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .summary-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            /* ç§»åŠ¨ç«¯è¡¨æ ¼ä¼˜åŒ– */
            .records-table {
                font-size: 12px;
            }
            
            .records-table th,
            .records-table td {
                padding: 8px 4px;
            }
            
            /* ç§»åŠ¨ç«¯æŒ‰é’®ä¼˜åŒ– */
            .btn {
                padding: 8px 12px;
                font-size: 14px;
                margin: 2px;
            }
            
            /* ç§»åŠ¨ç«¯è¡¨å•ä¼˜åŒ– */
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-group label {
                font-size: 14px;
                margin-bottom: 5px;
            }
            
            .form-group input,
            .form-group select {
                padding: 10px;
                font-size: 14px;
            }
            
            /* ç§»åŠ¨ç«¯å†å²è®°å½•å¯¼èˆªä¼˜åŒ– */
            .week-history-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            
            .week-history-card {
                padding: 15px;
            }
            
            /* ç§»åŠ¨ç«¯è·‘å‹å¡ç‰‡ä¼˜åŒ– */
            .runner-card {
                padding: 15px;
                margin-bottom: 10px;
            }
            
            .runner-name {
                font-size: 16px;
            }
            
            .runner-stats {
                font-size: 12px;
            }
            
            /* ç§»åŠ¨ç«¯æ ‡é¢˜ä¼˜åŒ– */
            .header h1 {
                font-size: 24px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            .section h2 {
                font-size: 18px;
                padding: 10px;
                margin: -20px -20px 20px -20px;
            }
            
            /* ç§»åŠ¨ç«¯å‘¨ç»Ÿè®¡ä¼˜åŒ– */
            .day-stat {
                padding: 8px;
                font-size: 12px;
            }
            
            .day-stat .day-name {
                font-size: 10px;
            }
            
            /* ç§»åŠ¨ç«¯å†å²è®°å½•è¯¦æƒ…ä¼˜åŒ– */
            .week-history-details {
                font-size: 14px;
            }
            
            .history-runner-item {
                padding: 10px;
                margin-bottom: 8px;
            }
            
            /* ç§»åŠ¨ç«¯ç»Ÿè®¡å¡ç‰‡ä¼˜åŒ– */
            .stat-card {
                padding: 15px;
            }
            
            .stat-number {
                font-size: 1.5em;
            }
            
            .stat-label {
                font-size: 0.8em;
            }
            
            /* ç§»åŠ¨ç«¯è·‘å‹å¡ç‰‡ä¼˜åŒ– */
            .runner-card {
                padding: 15px;
                margin-bottom: 10px;
            }
            
            .runner-name {
                font-size: 1.1em;
            }
            
            .runner-target {
                font-size: 0.8em;
            }
            
            .progress-bar {
                height: 15px;
            }
            
            .progress-fill {
                font-size: 10px;
            }
            
            /* ç§»åŠ¨ç«¯å¯¼èˆªæŒ‰é’®ç»„ä¼˜åŒ– */
            .section > div[style*="display: flex"] {
                flex-direction: column;
                gap: 10px;
            }
            
            .section > div[style*="display: flex"] > button {
                width: 100%;
                margin: 0;
            }
            
            .section > div[style*="display: flex"] > div {
                width: 100%;
                margin: 10px 0;
            }
            
            /* å·²ç§»é™¤record-sectionå“åº”å¼å¸ƒå±€ - ç•Œé¢ç®€åŒ– */
        }
        
        /* è¶…å°å±å¹•é¢å¤–ä¼˜åŒ– */
        @media (max-width: 480px) {
            .container {
                margin: 5px;
                border-radius: 8px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .section h2 {
                font-size: 16px;
                margin: -15px -15px 15px -15px;
            }
            
            .records-table {
                font-size: 11px;
            }
            
            .records-table th,
            .records-table td {
                padding: 6px 2px;
            }
            
            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .week-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
            }
            
            .day-stat {
                padding: 6px;
                font-size: 11px;
            }
            
            /* è¶…å°å±å¹•ä¸‹çš„å¸ƒå±€è°ƒæ•´ */
            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .week-history-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .stat-card,
            .week-history-card {
                padding: 12px;
            }
            
            .stat-number,
            .week-history-card .stat-value {
                font-size: 18px;
            }
        }
        
        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px; /* iOSæ¨èçš„æœ€å°è§¦æ‘¸ç›®æ ‡ */
                -webkit-tap-highlight-color: transparent;
            }
            
            .btn:active {
                transform: scale(0.98);
                transition: transform 0.1s ease;
            }
            
            .runner-card {
                -webkit-tap-highlight-color: transparent;
            }
            
            .runner-card:active {
                transform: scale(0.99);
                transition: transform 0.1s ease;
            }
            
            /* ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½ */
            .records-table {
                -webkit-overflow-scrolling: touch;
                overflow-x: auto;
                display: block;
            }
            
            /* é˜²æ­¢åŒå‡»ç¼©æ”¾ */
            .btn, .runner-card, .day-stat {
                touch-action: manipulation;
            }
            
            /* ç§»åŠ¨ç«¯æ›´å¥½çš„è§†è§‰åé¦ˆ */
            .week-history-card {
                transition: all 0.2s ease;
            }
            
            .week-history-card:active {
                transform: translateY(1px);
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        }
        
        /* æš—è‰²æ¨¡å¼æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
            }
            
            .container {
                background-color: #2d2d2d;
                color: #e0e0e0;
            }
            
            .section {
                background-color: #3d3d3d;
                border-color: #555;
            }
            
            .section h2 {
                background-color: #4a4a4a;
                color: #fff;
            }
            
            .form-group input,
            .form-group select {
                background-color: #4a4a4a;
                color: #e0e0e0;
                border-color: #666;
            }
            
            .records-table {
                background-color: #3d3d2d;
                color: #e0e0e0;
            }
            
            .records-table th {
                background-color: #4a4a4a;
            }
            
            .records-table tr:nth-child(even) {
                background-color: #454545;
            }
            
            .runner-card {
                background-color: #4a4a4a;
                border-color: #666;
            }
            
            .week-history-card {
                background-color: #4a4a4a;
                border-color: #666;
            }
            
            .day-stat {
                background-color: #4a4a4a;
                border-color: #666;
            }
            
            .status-complete {
                color: #4caf50;
            }
            
            .status-incomplete {
                color: #f44336;
            }
        }
        
        /* å¾®ä¿¡æµè§ˆå™¨ä¸“ç”¨ä¼˜åŒ– */
        .wechat-optimized .container {
            border-radius: 0;
            box-shadow: none;
            margin: 0;
            max-width: 100vw;
        }
        
        .wechat-optimized .header {
            border-radius: 0;
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .wechat-optimized .header h1 {
            font-size: 1.5em;
            margin-bottom: 5px;
        }
        
        .wechat-optimized .main-content {
            padding: 10px;
            padding-bottom: 20px;
        }
        
        .wechat-optimized .section {
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
        }
        
        .wechat-optimized .section h2 {
            font-size: 1.2em;
            margin: -15px -15px 10px -15px;
            padding: 10px 15px;
        }
        
        .wechat-optimized .btn {
            padding: 8px 16px;
            font-size: 14px;
            border-radius: 6px;
            min-height: 40px;
        }
        
        .wechat-optimized .runner-card {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .wechat-optimized .runner-name {
            font-size: 1.1em;
        }
        
        .wechat-optimized .stat-card {
            padding: 8px;
            border-radius: 6px;
        }
        
        .wechat-optimized .stat-number {
            font-size: 1.2em;
        }
        
        .wechat-optimized .stat-label {
            font-size: 0.8em;
        }
        
        /* å¾®ä¿¡æµè§ˆå™¨å®‰å…¨åŒºåŸŸé€‚é… */
        .wechat-safe-area {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        /* å¾®ä¿¡æµè§ˆå™¨æ»šåŠ¨ä¼˜åŒ– */
        .wechat-scroll {
            -webkit-overflow-scrolling: touch;
            overflow-scrolling: touch;
        }
        
        /* å¾®ä¿¡æµè§ˆå™¨ç‚¹å‡»æ•ˆæœä¼˜åŒ– */
        .wechat-tap {
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            tap-highlight-color: rgba(0,0,0,0);
        }

        /* åŒæ­¥çŠ¶æ€æ ·å¼ */
        .sync-status {
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .sync-status.syncing {
            background: linear-gradient(45deg, #007bff, #0056b3) !important;
            color: white !important;
            animation: pulse 1.5s infinite;
        }
        
        .sync-status.synced {
            background: linear-gradient(45deg, #28a745, #1e7e34) !important;
            color: white !important;
        }
        
        .sync-status.offline {
            background: linear-gradient(45deg, #6c757d, #545b62) !important;
            color: white !important;
        }
        
        .sync-status.pending {
            background: linear-gradient(45deg, #ffc107, #e0a800) !important;
            color: #212529 !important;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
    <!-- Tesseract.js OCRåº“å¼•ç”¨å·²ç§»é™¤ - AI/OCRåŠŸèƒ½å·²æ¸…ç† -->
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸƒâ€è·‘æ­¥æ‰“å¡è®°å½•ç³»ç»Ÿ</h1>
            <p>æ¯å‘¨è‡³å°‘3æ¬¡ï¼Œæ¯æ¬¡5å…¬é‡Œï¼ŒåšæŒå°±æ˜¯èƒœåˆ©ï¼</p>
            <button id="syncButton" class="btn btn-info" onclick="manualSync()" style="position: absolute; top: 10px; right: 10px; font-size: 12px; padding: 5px 10px;">ğŸ”„ æ‰‹åŠ¨åŒæ­¥</button>
            <button id="configButton" class="btn btn-warning" onclick="showConfigModal()" style="position: absolute; top: 10px; right: 120px; font-size: 12px; padding: 5px 10px;">âš™ï¸ é…ç½®</button>
        </div>

        <div class="main-content">
            <!-- æ·»åŠ æ–°æˆå‘˜ -->
            <div class="section">
                <h2>æ·»åŠ æ–°è·‘å‹</h2>
                <div class="form-group">
                    <label for="newRunnerName">è·‘å‹å§“åï¼š</label>
                    <input type="text" id="newRunnerName" placeholder="è¯·è¾“å…¥è·‘å‹å§“å">
                </div>
                <div class="form-group">
                    <label for="newRunnerTarget">å‘¨ç›®æ ‡è·ç¦»ï¼š</label>
                    <select id="newRunnerTarget">
                        <option value="20">20å…¬é‡Œ</option>
                        <option value="25">25å…¬é‡Œ</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="addRunner()">æ·»åŠ è·‘å‹</button>
            </div>

            <!-- æ·»åŠ è·‘æ­¥è®°å½• -->
            <div class="section">
                <h2>æ·»åŠ è·‘æ­¥è®°å½•</h2>
                <div class="form-group">
                    <label for="runnerSelect">é€‰æ‹©è·‘å‹ï¼š</label>
                    <select id="runnerSelect"></select>
                </div>
                <div class="form-group">
                    <label for="runDate">è·‘æ­¥æ—¥æœŸï¼š</label>
                    <input type="date" id="runDate">
                </div>
                <div class="form-group">
                    <label for="runDistance">è·‘æ­¥è·ç¦»ï¼ˆå…¬é‡Œï¼‰ï¼š</label>
                    <input type="number" id="runDistance" step="0.1" min="0" placeholder="è¯·è¾“å…¥è·‘æ­¥è·ç¦»">
                </div>
                <div class="form-group">
                    <label for="runDuration">è·‘æ­¥æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼š</label>
                    <input type="number" id="runDuration" step="1" min="0" placeholder="è¯·è¾“å…¥è·‘æ­¥æ—¶é•¿">
                </div>
                <div class="form-group">
                    <label for="runPace">è·‘æ­¥é…é€Ÿï¼ˆåˆ†é’Ÿ/å…¬é‡Œï¼‰ï¼š</label>
                    <input type="text" id="runPace" placeholder="è‡ªåŠ¨è®¡ç®—æˆ–æ‰‹åŠ¨è¾“å…¥ï¼Œå¦‚ï¼š5:30">
                </div>
                <div class="form-group">
                    <label for="runCalories">è·‘æ­¥æ¶ˆè€—ï¼ˆå¡è·¯é‡Œï¼‰ï¼š</label>
                    <input type="number" id="runCalories" step="1" min="0" placeholder="è‡ªåŠ¨ä¼°ç®—æˆ–æ‰‹åŠ¨è¾“å…¥">
                </div>
                <button class="btn" onclick="addRecord()">æ·»åŠ è®°å½•</button>
                <button class="btn btn-warning" onclick="calculatePaceAndCalories()">è®¡ç®—é…é€Ÿå’Œæ¶ˆè€—</button>
            </div>

            <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
            <div class="section">
                <h2>æœ¬å‘¨ç»Ÿè®¡æ¦‚è§ˆ</h2>
                <div class="summary-stats" id="summaryStats"></div>
                <div class="penalty-info" id="penaltyInfo"></div>
            </div>

            <!-- è·‘å‹åˆ—è¡¨ -->
            <div class="section">
                <h2>è·‘å‹å®Œæˆæƒ…å†µ</h2>
                <div class="runner-list" id="runnerList"></div>
            </div>

            <!-- æ¯å‘¨å†å²è®°å½• -->
            <div class="section">
                <h2>æ¯å‘¨å†å²è®°å½•</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button class="btn" onclick="changeWeek(-1)">â† ä¸Šä¸€å‘¨</button>
                    <div style="text-align: center;">
                        <span id="currentWeekDisplay"></span>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-warning" onclick="goToCurrentWeek()">è¿”å›æœ¬å‘¨</button>
                        </div>
                    </div>
                    <button class="btn" onclick="changeWeek(1)">ä¸‹ä¸€å‘¨ â†’</button>
                </div>
                <div class="week-history-stats" id="weekHistoryStats"></div>
                <div class="week-history-details" id="weekHistoryDetails"></div>
            </div>

            <!-- è¯¦ç»†è®°å½• -->
            <div class="section">
                <h2>è¯¦ç»†è·‘æ­¥è®°å½•</h2>
                <table class="records-table" id="recordsTable">
                    <thead>
                        <tr>
                            <th>è·‘å‹</th>
                            <th>æ—¥æœŸ</th>
                            <th>è·ç¦»(km)</th>
                            <th>æ—¶é•¿(åˆ†)</th>
                            <th>é…é€Ÿ</th>
                            <th>æ¶ˆè€—(å¡)</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // äº‘ç«¯åŒæ­¥é…ç½®
        const CLOUD_SYNC_CONFIG = (() => {
            const savedConfig = localStorage.getItem('cloudSyncConfig');
            if (savedConfig) {
                return JSON.parse(savedConfig);
            }
            return {
                apiKey: '', // JSONBin.io APIå¯†é’¥
                binId: '', // å­˜å‚¨æ•°æ®çš„bin ID
                enableSync: false // æ˜¯å¦å¯ç”¨äº‘ç«¯åŒæ­¥
            };
        })();

        // æ•°æ®å­˜å‚¨
        let runners = JSON.parse(localStorage.getItem('runners')) || [];
        let records = JSON.parse(localStorage.getItem('runningRecords')) || [];
        
        // å†å²è®°å½•ç›¸å…³å˜é‡
        let currentWeekOffset = 0; // å½“å‰æŸ¥çœ‹çš„å‘¨åç§»é‡ï¼ˆ0è¡¨ç¤ºæœ¬å‘¨ï¼Œ-1è¡¨ç¤ºä¸Šå‘¨ï¼Œ1è¡¨ç¤ºä¸‹å‘¨ï¼‰
        
        // åŒæ­¥çŠ¶æ€ç®¡ç†
        let syncStatus = {
            isOnline: navigator.onLine,
            lastSyncTime: localStorage.getItem('lastSyncTime') || null,
            pendingSync: JSON.parse(localStorage.getItem('pendingSync') || '[]'),
            isSyncing: false
        };

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            document.getElementById('runDate').valueAsDate = new Date();
            
            // æ·»åŠ åŒæ­¥çŠ¶æ€æ˜¾ç¤ºå…ƒç´ 
            const header = document.querySelector('.header');
            if (header) {
                const syncStatusElement = document.createElement('div');
                syncStatusElement.id = 'syncStatus';
                syncStatusElement.className = 'sync-status';
                syncStatusElement.style.cssText = `
                    position: absolute;
                    top: 10px;
                    right: 10px;
                    font-size: 12px;
                    padding: 5px 10px;
                    border-radius: 15px;
                    background: rgba(255,255,255,0.9);
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                    z-index: 100;
                `;
                header.appendChild(syncStatusElement);
            }
            
            // ä»äº‘ç«¯åŒæ­¥åˆå§‹æ•°æ®
            if (CLOUD_SYNC_CONFIG.enableSync && navigator.onLine) {
                await syncFromCloud();
            }
            
            // æ›´æ–°ç•Œé¢
            updateRunnerSelect();
            updateRunnerList();
            updateRecordsTable();
            updateSummaryStats();
            updateWeekHistory(); // åˆå§‹åŒ–å†å²è®°å½•æ˜¾ç¤º
            updateSyncStatus(); // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
            
            // å¯åŠ¨è‡ªåŠ¨åŒæ­¥
            startAutoSync();
        });

        // ç®¡ç†å‘˜å¯†ç ï¼ˆå¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹ï¼‰
        const ADMIN_PASSWORD = 'running2024';

        // äº‘ç«¯åŒæ­¥åŠŸèƒ½
        async function syncToCloud() {
            if (!CLOUD_SYNC_CONFIG.enableSync || !CLOUD_SYNC_CONFIG.apiKey || !CLOUD_SYNC_CONFIG.binId) {
                console.log('äº‘ç«¯åŒæ­¥æœªé…ç½®æˆ–å·²ç¦ç”¨');
                return false;
            }

            if (syncStatus.isSyncing) {
                console.log('åŒæ­¥æ­£åœ¨è¿›è¡Œä¸­...');
                return false;
            }

            syncStatus.isSyncing = true;
            updateSyncStatus();

            try {
                const data = {
                    runners: runners,
                    records: records,
                    lastUpdated: new Date().toISOString(),
                    version: '1.0'
                };

                const response = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_SYNC_CONFIG.binId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': CLOUD_SYNC_CONFIG.apiKey,
                        'X-Bin-Private': 'false' // è®¾ç½®ä¸ºå…¬å¼€è®¿é—®
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    syncStatus.lastSyncTime = new Date().toISOString();
                    localStorage.setItem('lastSyncTime', syncStatus.lastSyncTime);
                    syncStatus.pendingSync = [];
                    localStorage.setItem('pendingSync', JSON.stringify(syncStatus.pendingSync));
                    console.log('æ•°æ®åŒæ­¥åˆ°äº‘ç«¯æˆåŠŸ');
                    return true;
                } else {
                    console.error('åŒæ­¥åˆ°äº‘ç«¯å¤±è´¥:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('åŒæ­¥åˆ°äº‘ç«¯å‡ºé”™:', error);
                return false;
            } finally {
                syncStatus.isSyncing = false;
                updateSyncStatus();
            }
        }

        // ä»äº‘ç«¯åŒæ­¥æ•°æ®
        async function syncFromCloud() {
            if (!CLOUD_SYNC_CONFIG.enableSync || !CLOUD_SYNC_CONFIG.apiKey || !CLOUD_SYNC_CONFIG.binId) {
                console.log('äº‘ç«¯åŒæ­¥æœªé…ç½®æˆ–å·²ç¦ç”¨');
                return false;
            }

            if (syncStatus.isSyncing) {
                console.log('åŒæ­¥æ­£åœ¨è¿›è¡Œä¸­...');
                return false;
            }

            syncStatus.isSyncing = true;
            updateSyncStatus();

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${CLOUD_SYNC_CONFIG.binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': CLOUD_SYNC_CONFIG.apiKey
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const cloudData = result.record;

                    if (cloudData && cloudData.runners && cloudData.records) {
                        // åˆå¹¶æœ¬åœ°å’Œäº‘ç«¯æ•°æ®
                        runners = mergeData(runners, cloudData.runners, 'id');
                        records = mergeData(records, cloudData.records, 'id');

                        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                        localStorage.setItem('runners', JSON.stringify(runners));
                        localStorage.setItem('runningRecords', JSON.stringify(records));

                        syncStatus.lastSyncTime = new Date().toISOString();
                        localStorage.setItem('lastSyncTime', syncStatus.lastSyncTime);

                        console.log('ä»äº‘ç«¯åŒæ­¥æ•°æ®æˆåŠŸ');
                        return true;
                    }
                } else if (response.status === 404) {
                    console.log('äº‘ç«¯æ•°æ®ä¸å­˜åœ¨ï¼Œé¦–æ¬¡ä½¿ç”¨');
                    return true;
                } else {
                    console.error('ä»äº‘ç«¯åŒæ­¥å¤±è´¥:', response.status);
                    return false;
                }
            } catch (error) {
                console.error('ä»äº‘ç«¯åŒæ­¥å‡ºé”™:', error);
                return false;
            } finally {
                syncStatus.isSyncing = false;
                updateSyncStatus();
            }
        }

        // åˆå¹¶æ•°æ®ï¼ˆä»¥äº‘ç«¯æ•°æ®ä¸ºå‡†ï¼Œä¿ç•™æœ¬åœ°ç‹¬æœ‰æ•°æ®ï¼‰
        function mergeData(localData, cloudData, keyField) {
            const cloudMap = new Map(cloudData.map(item => [item[keyField], item]));
            const localMap = new Map(localData.map(item => [item[keyField], item]));
            
            // ä½¿ç”¨äº‘ç«¯æ•°æ®ä¸ºä¸»
            const merged = [...cloudData];
            
            // æ·»åŠ æœ¬åœ°ç‹¬æœ‰æ•°æ®
            localData.forEach(item => {
                if (!cloudMap.has(item[keyField])) {
                    merged.push(item);
                }
            });
            
            return merged;
        }

        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatus() {
            const statusElement = document.getElementById('syncStatus');
            if (!statusElement) return;

            let statusText = '';
            let statusClass = '';

            if (syncStatus.isSyncing) {
                statusText = 'ğŸ”„ åŒæ­¥ä¸­...';
                statusClass = 'syncing';
            } else if (!navigator.onLine) {
                statusText = 'ğŸ“¡ ç¦»çº¿æ¨¡å¼';
                statusClass = 'offline';
            } else if (syncStatus.lastSyncTime) {
                const lastSync = new Date(syncStatus.lastSyncTime);
                const now = new Date();
                const diffMinutes = Math.floor((now - lastSync) / 60000);
                
                if (diffMinutes < 1) {
                    statusText = 'âœ… åˆšåˆšåŒæ­¥';
                } else if (diffMinutes < 60) {
                    statusText = `âœ… ${diffMinutes}åˆ†é’Ÿå‰åŒæ­¥`;
                } else {
                    const hours = Math.floor(diffMinutes / 60);
                    statusText = `âœ… ${hours}å°æ—¶å‰åŒæ­¥`;
                }
                statusClass = 'synced';
            } else {
                statusText = 'â³ æœªåŒæ­¥';
                statusClass = 'pending';
            }

            statusElement.textContent = statusText;
            statusElement.className = `sync-status ${statusClass}`;
        }

        // è‡ªåŠ¨åŒæ­¥ï¼ˆå®šæ—¶å™¨ï¼‰
        function startAutoSync() {
            if (!CLOUD_SYNC_CONFIG.enableSync) return;

            // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡åŒæ­¥
            setInterval(async () => {
                if (navigator.onLine && !syncStatus.isSyncing) {
                    // å¦‚æœæœ‰å¾…åŒæ­¥æ•°æ®ï¼Œå…ˆä¸Šä¼ åˆ°äº‘ç«¯
                    if (syncStatus.pendingSync.length > 0) {
                        await syncToCloud();
                    }
                    // ç„¶åä»äº‘ç«¯æ‹‰å–æœ€æ–°æ•°æ®
                    await syncFromCloud();
                    // æ›´æ–°ç•Œé¢
                    updateRunnerSelect();
                    updateRunnerList();
                    updateRecordsTable();
                    updateSummaryStats();
                }
            }, 30000); // 30ç§’åŒæ­¥ä¸€æ¬¡

            // ç½‘ç»œçŠ¶æ€å˜åŒ–æ—¶ç«‹å³åŒæ­¥
            window.addEventListener('online', async () => {
                syncStatus.isOnline = true;
                if (!syncStatus.isSyncing) {
                    await syncFromCloud();
                    updateAllUI();
                }
            });

            window.addEventListener('offline', () => {
                syncStatus.isOnline = false;
                updateSyncStatus();
            });
        }

        // æ›´æ–°æ‰€æœ‰UI
        function updateAllUI() {
            updateRunnerSelect();
            updateRunnerList();
            updateRecordsTable();
            updateSummaryStats();
            updateWeekHistory();
        }

        // å¤„ç†å¾…åŒæ­¥é˜Ÿåˆ—
        async function processPendingSync() {
            if (syncStatus.pendingSync.length === 0 || !navigator.onLine || !CLOUD_SYNC_CONFIG.enableSync) {
                return;
            }

            console.log(`å¤„ç†å¾…åŒæ­¥é˜Ÿåˆ—ï¼Œå…± ${syncStatus.pendingSync.length} é¡¹å¾…åŒæ­¥`);
            
            try {
                // å…ˆå°è¯•åŒæ­¥åˆ°äº‘ç«¯
                const success = await syncToCloud();
                
                if (success) {
                    // åŒæ­¥æˆåŠŸåæ¸…ç©ºé˜Ÿåˆ—
                    syncStatus.pendingSync = [];
                    localStorage.setItem('pendingSyncQueue', JSON.stringify(syncStatus.pendingSync));
                    console.log('å¾…åŒæ­¥é˜Ÿåˆ—å¤„ç†å®Œæˆ');
                }
            } catch (error) {
                console.error('å¤„ç†å¾…åŒæ­¥é˜Ÿåˆ—å¤±è´¥:', error);
            }
        }

        // å®æ—¶æ•°æ®åŒæ­¥ç®¡ç†å™¨
        class RealtimeSyncManager {
            constructor() {
                this.syncInterval = null;
                this.lastSyncTime = 0;
                this.syncCooldown = 2000; // 2ç§’åŒæ­¥å†·å´æ—¶é—´
                this.setupCrossTabCommunication();
                this.setupStorageListener();
            }

            // è®¾ç½®è·¨æ ‡ç­¾é¡µé€šä¿¡
            setupCrossTabCommunication() {
                // ä½¿ç”¨BroadcastChannel APIï¼ˆå¦‚æœæ”¯æŒï¼‰
                if (window.BroadcastChannel) {
                    this.broadcastChannel = new BroadcastChannel('runningAppSync');
                    this.broadcastChannel.onmessage = (event) => {
                        this.handleCrossTabMessage(event.data);
                    };
                }

                // ä½¿ç”¨localStorageäº‹ä»¶ä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                window.addEventListener('storage', (event) => {
                    if (event.key === 'runningAppSync' && event.newValue) {
                        this.handleCrossTabMessage(JSON.parse(event.newValue));
                    }
                });
            }

            // è®¾ç½®å­˜å‚¨ç›‘å¬å™¨
            setupStorageListener() {
                // ç›‘å¬æœ¬åœ°æ•°æ®å˜åŒ–
                const originalSetItem = localStorage.setItem;
                localStorage.setItem = (key, value) => {
                    originalSetItem.call(localStorage, key, value);
                    
                    // ç›‘å¬å…³é”®æ•°æ®å˜åŒ–
                    if (key === 'runners' || key === 'runningRecords') {
                        this.notifyDataChange(key, value);
                    }
                };
            }

            // å¤„ç†è·¨æ ‡ç­¾é¡µæ¶ˆæ¯
            handleCrossTabMessage(message) {
                switch (message.type) {
                    case 'dataChanged':
                        console.log(`æ”¶åˆ°æ•°æ®å˜æ›´é€šçŸ¥: ${message.dataType}`);
                        this.handleExternalDataChange(message.dataType);
                        break;
                    case 'syncRequest':
                        this.handleSyncRequest(message);
                        break;
                }
            }

            // å¤„ç†å¤–éƒ¨æ•°æ®å˜åŒ–
            async handleExternalDataChange(dataType) {
                const now = Date.now();
                if (now - this.lastSyncTime < this.syncCooldown) {
                    return; // é¿å…é¢‘ç¹åŒæ­¥
                }

                this.lastSyncTime = now;

                // ä»äº‘ç«¯åŒæ­¥æœ€æ–°æ•°æ®
                if (CLOUD_SYNC_CONFIG.enableSync && navigator.onLine) {
                    try {
                        await syncFromCloud();
                        updateAllUI();
                        console.log(`æ•°æ®å·²åŒæ­¥æ›´æ–°: ${dataType}`);
                    } catch (error) {
                        console.error('å®æ—¶åŒæ­¥å¤±è´¥:', error);
                    }
                }
            }

            // é€šçŸ¥æ•°æ®å˜åŒ–
            notifyDataChange(dataType, data) {
                const message = {
                    type: 'dataChanged',
                    dataType: dataType,
                    timestamp: Date.now(),
                    sourceTab: this.getTabId()
                };

                // ä½¿ç”¨BroadcastChannel
                if (this.broadcastChannel) {
                    this.broadcastChannel.postMessage(message);
                }

                // ä½¿ç”¨localStorageä½œä¸ºå¤‡é€‰
                try {
                    localStorage.setItem('runningAppSync', JSON.stringify(message));
                } catch (error) {
                    console.warn('è·¨æ ‡ç­¾é¡µé€šçŸ¥å¤±è´¥:', error);
                }
            }

            // è·å–æ ‡ç­¾é¡µID
            getTabId() {
                if (!this.tabId) {
                    this.tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                return this.tabId;
            }

            // å¯åŠ¨å®æ—¶åŒæ­¥
            startRealtimeSync() {
                if (!CLOUD_SYNC_CONFIG.enableSync) return;

                // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡æ•°æ®æ›´æ–°
                this.syncInterval = setInterval(async () => {
                    if (navigator.onLine && !syncStatus.isSyncing) {
                        try {
                            const lastCloudSync = localStorage.getItem('lastCloudSyncTime');
                            const now = Date.now();
                            
                            // å¦‚æœè¶…è¿‡30ç§’æ²¡æœ‰åŒæ­¥ï¼Œåˆ™è¿›è¡ŒåŒæ­¥
                            if (!lastCloudSync || (now - parseInt(lastCloudSync)) > 30000) {
                                await syncFromCloud();
                                updateAllUI();
                                localStorage.setItem('lastCloudSyncTime', now.toString());
                            }
                        } catch (error) {
                            console.error('å®šæ—¶åŒæ­¥å¤±è´¥:', error);
                        }
                    }
                }, 10000); // 10ç§’æ£€æŸ¥ä¸€æ¬¡

                console.log('å®æ—¶åŒæ­¥å·²å¯åŠ¨');
            }

            // åœæ­¢å®æ—¶åŒæ­¥
            stopRealtimeSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                    this.syncInterval = null;
                }

                if (this.broadcastChannel) {
                    this.broadcastChannel.close();
                }

                console.log('å®æ—¶åŒæ­¥å·²åœæ­¢');
            }

            // å¤„ç†åŒæ­¥è¯·æ±‚
            handleSyncRequest(message) {
                // å¯ä»¥åœ¨è¿™é‡Œå®ç°æ›´å¤æ‚çš„åŒæ­¥é€»è¾‘
                console.log('æ”¶åˆ°åŒæ­¥è¯·æ±‚:', message);
            }
        }

        // åˆ›å»ºå®æ—¶åŒæ­¥ç®¡ç†å™¨å®ä¾‹
        let realtimeSyncManager = null;

        // æ‰‹åŠ¨åŒæ­¥
        async function manualSync() {
            if (!CLOUD_SYNC_CONFIG.enableSync) {
                alert('äº‘ç«¯åŒæ­¥åŠŸèƒ½æœªå¯ç”¨ï¼Œè¯·å…ˆé…ç½®APIå¯†é’¥');
                return;
            }

            const syncButton = document.getElementById('syncButton');
            syncButton.disabled = true;
            syncButton.textContent = 'ğŸ”„ åŒæ­¥ä¸­...';

            try {
                // å…ˆä¸Šä¼ æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯
                const uploadSuccess = await syncToCloud();
                // ç„¶åä»äº‘ç«¯ä¸‹è½½æœ€æ–°æ•°æ®
                const downloadSuccess = await syncFromCloud();

                if (uploadSuccess && downloadSuccess) {
                    // æ›´æ–°æ‰€æœ‰ç•Œé¢
                    updateAllUI();
                    alert('âœ… æ•°æ®åŒæ­¥æˆåŠŸï¼');
                } else {
                    alert('âŒ æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé…ç½®');
                }
            } catch (error) {
                console.error('æ‰‹åŠ¨åŒæ­¥å‡ºé”™:', error);
                alert('âŒ åŒæ­¥è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯');
            } finally {
                syncButton.disabled = false;
                syncButton.textContent = 'ğŸ”„ æ‰‹åŠ¨åŒæ­¥';
            }
        }

        // æ˜¾ç¤ºé…ç½®æ¨¡æ€æ¡†
        function showConfigModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                text-align: center;
                min-width: 400px;
                max-width: 500px;
            `;

            modalContent.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #333;">âš™ï¸ äº‘ç«¯åŒæ­¥é…ç½®</h3>
                <div style="text-align: left; margin-bottom: 20px;">
                    <p style="margin-bottom: 15px; color: #666; line-height: 1.5;">
                        ä¸ºäº†å®ç°å¤šè®¾å¤‡æ•°æ®åŒæ­¥ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ JSONBin.io æœåŠ¡ï¼š
                    </p>
                    <ol style="margin-bottom: 15px; color: #666; padding-left: 20px; line-height: 1.6;">
                        <li>è®¿é—® <a href="https://jsonbin.io" target="_blank" style="color: #007bff;">jsonbin.io</a></li>
                        <li>æ³¨å†Œå…è´¹è´¦æˆ·</li>
                        <li>åˆ›å»ºæ–°çš„ Binï¼ˆæ•°æ®å®¹å™¨ï¼‰</li>
                        <li>è·å– API å¯†é’¥å’Œ Bin ID</li>
                    </ol>
                </div>
                <div style="margin-bottom: 15px; text-align: left;">
                    <label style="display: block; margin-bottom: 5px; color: #333;">API å¯†é’¥ï¼š</label>
                    <input type="password" id="apiKeyInput" placeholder="è¾“å…¥æ‚¨çš„ API å¯†é’¥" 
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; 
                                  border-radius: 8px; margin-bottom: 10px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 20px; text-align: left;">
                    <label style="display: block; margin-bottom: 5px; color: #333;">Bin IDï¼š</label>
                    <input type="text" id="binIdInput" placeholder="è¾“å…¥æ‚¨çš„ Bin ID" 
                           style="width: 100%; padding: 10px; border: 2px solid #ddd; 
                                  border-radius: 8px; margin-bottom: 10px; font-size: 14px;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="enableSyncCheckbox" ${CLOUD_SYNC_CONFIG.enableSync ? 'checked' : ''} 
                               style="margin-right: 8px;">
                        <span style="color: #333;">å¯ç”¨äº‘ç«¯åŒæ­¥</span>
                    </label>
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-success" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
                    <button class="btn btn-danger" onclick="closeConfigModal()">å–æ¶ˆ</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // å¡«å……å½“å‰é…ç½®
            document.getElementById('apiKeyInput').value = CLOUD_SYNC_CONFIG.apiKey || '';
            document.getElementById('binIdInput').value = CLOUD_SYNC_CONFIG.binId || '';

            // ä¿å­˜é…ç½®å‡½æ•°
            window.saveConfig = function() {
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                const binId = document.getElementById('binIdInput').value.trim();
                const enableSync = document.getElementById('enableSyncCheckbox').checked;

                if (enableSync && (!apiKey || !binId)) {
                    alert('å¯ç”¨åŒæ­¥æ—¶å¿…é¡»å¡«å†™ API å¯†é’¥å’Œ Bin ID');
                    return;
                }

                // ä¿å­˜é…ç½®åˆ°æœ¬åœ°å­˜å‚¨
                const newConfig = {
                    apiKey: apiKey,
                    binId: binId,
                    enableSync: enableSync
                };

                localStorage.setItem('cloudSyncConfig', JSON.stringify(newConfig));
                
                // æ›´æ–°å…¨å±€é…ç½®
                Object.assign(CLOUD_SYNC_CONFIG, newConfig);
                
                alert('âœ… é…ç½®ä¿å­˜æˆåŠŸï¼');
                closeConfigModal();
                
                // å¦‚æœå¯ç”¨äº†åŒæ­¥ï¼Œç«‹å³å°è¯•åŒæ­¥
                if (enableSync && navigator.onLine) {
                    setTimeout(manualSync, 1000);
                }
            };

            // å…³é—­æ¨¡æ€æ¡†å‡½æ•°
            window.closeConfigModal = function() {
                document.body.removeChild(modal);
                delete window.saveConfig;
                delete window.closeConfigModal;
            };

            // ä¿å­˜é…ç½®å‡½æ•°
            window.saveConfig = function() {
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                const binId = document.getElementById('binIdInput').value.trim();
                const enableSync = document.getElementById('enableSyncCheckbox').checked;

                if (enableSync && (!apiKey || !binId)) {
                    alert('å¯ç”¨åŒæ­¥æ—¶å¿…é¡»å¡«å†™ API å¯†é’¥å’Œ Bin IDï¼');
                    return;
                }

                // æ›´æ–°é…ç½®
                CLOUD_SYNC_CONFIG.apiKey = apiKey;
                CLOUD_SYNC_CONFIG.binId = binId;
                CLOUD_SYNC_CONFIG.enableSync = enableSync;

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('cloudSyncConfig', JSON.stringify(CLOUD_SYNC_CONFIG));

                closeConfigModal();
                alert('âœ… é…ç½®å·²ä¿å­˜ï¼');
                
                // å¦‚æœå¯ç”¨äº†åŒæ­¥ï¼Œç«‹å³å°è¯•åŒæ­¥
                if (enableSync && navigator.onLine) {
                    manualSync();
                }
            };

            // å…³é—­æ¨¡æ€æ¡†å‡½æ•°
            window.closeConfigModal = function() {
                document.body.removeChild(modal);
                delete window.saveConfig;
                delete window.closeConfigModal;
            };
        }

        // æ˜¾ç¤ºå¯†ç è¾“å…¥æ¨¡æ€æ¡†
        function showPasswordModal(callback) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 30px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                text-align: center;
                min-width: 300px;
            `;

            modalContent.innerHTML = `
                <h3 style="margin-bottom: 20px; color: #333;">ğŸ” ç®¡ç†å‘˜éªŒè¯</h3>
                <p style="margin-bottom: 15px; color: #666;">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š</p>
                <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥å¯†ç " 
                       style="width: 100%; padding: 12px; border: 2px solid #ddd; 
                              border-radius: 8px; margin-bottom: 20px; font-size: 16px;">
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-success" onclick="confirmPassword()">ç¡®è®¤</button>
                    <button class="btn btn-danger" onclick="cancelPassword()">å–æ¶ˆ</button>
                </div>
            `;

            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // èšç„¦åˆ°å¯†ç è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('adminPassword').focus();
            }, 100);

            // ç¡®è®¤å¯†ç å‡½æ•°
            window.confirmPassword = function() {
                const password = document.getElementById('adminPassword').value;
                if (password === ADMIN_PASSWORD) {
                    document.body.removeChild(modal);
                    delete window.confirmPassword;
                    delete window.cancelPassword;
                    callback(true);
                } else {
                    alert('å¯†ç é”™è¯¯ï¼');
                    document.getElementById('adminPassword').value = '';
                    document.getElementById('adminPassword').focus();
                }
            };

            // å–æ¶ˆå¯†ç å‡½æ•°
            window.cancelPassword = function() {
                document.body.removeChild(modal);
                delete window.confirmPassword;
                delete window.cancelPassword;
                callback(false);
            };

            // å›è½¦ç¡®è®¤
            document.getElementById('adminPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmPassword();
                }
            });
        }

        // æ·»åŠ è·‘å‹ï¼ˆå¸¦æƒé™éªŒè¯ï¼‰
        function addRunner() {
            const name = document.getElementById('newRunnerName').value.trim();
            const target = parseInt(document.getElementById('newRunnerTarget').value);

            if (!name) {
                alert('è¯·è¾“å…¥è·‘å‹å§“åï¼');
                return;
            }

            if (runners.some(runner => runner.name === name)) {
                alert('è¯¥è·‘å‹å·²å­˜åœ¨ï¼');
                return;
            }

            // æ˜¾ç¤ºå¯†ç éªŒè¯æ¨¡æ€æ¡†
            showPasswordModal(function(isAuthenticated) {
                if (isAuthenticated) {
                    const newRunner = {
                        id: Date.now(),
                        name: name,
                        targetDistance: target,
                        joinDate: new Date().toISOString().split('T')[0]
                    };

                    runners.push(newRunner);
                    localStorage.setItem('runners', JSON.stringify(runners));

                    // åŒæ­¥åˆ°äº‘ç«¯
                    if (CLOUD_SYNC_CONFIG.enableSync && navigator.onLine) {
                        (async () => {
                            try {
                                await syncToCloud();
                                // åŒæ­¥æˆåŠŸåç«‹å³æ‹‰å–æœ€æ–°æ•°æ®
                                await syncFromCloud();
                                updateAllUI();
                            } catch (error) {
                                console.error('åŒæ­¥å¤±è´¥:', error);
                            }
                        })();
                    } else if (CLOUD_SYNC_CONFIG.enableSync) {
                        // ç¦»çº¿æ—¶æ·»åŠ åˆ°å¾…åŒæ­¥é˜Ÿåˆ—
                        syncStatus.pendingSync.push({
                            type: 'addRunner', 
                            data: newRunner,
                            timestamp: Date.now()
                        });
                        localStorage.setItem('pendingSyncQueue', JSON.stringify(syncStatus.pendingSync));
                    }

                    // æ¸…ç©ºè¾“å…¥
                    document.getElementById('newRunnerName').value = '';

                    // æ›´æ–°ç•Œé¢
                    updateRunnerSelect();
                    updateRunnerList();
                    updateSummaryStats();

                    alert('è·‘å‹æ·»åŠ æˆåŠŸï¼');
                } else {
                    alert('æ·»åŠ è·‘å‹å·²å–æ¶ˆ');
                }
            });
        }

        // æ›´æ–°è·‘å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateRunnerSelect() {
            const select = document.getElementById('runnerSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è·‘å‹</option>';
            
            runners.forEach(runner => {
                const option = document.createElement('option');
                option.value = runner.id;
                option.textContent = runner.name;
                select.appendChild(option);
            });
        }

        // è®¡ç®—é…é€Ÿå’Œå¡è·¯é‡Œæ¶ˆè€—
        function calculatePaceAndCalories() {
            const distance = parseFloat(document.getElementById('runDistance').value);
            const duration = parseFloat(document.getElementById('runDuration').value);
            const runnerId = document.getElementById('runnerSelect').value;

            if (!runnerId) {
                alert('è¯·å…ˆé€‰æ‹©è·‘å‹ï¼');
                return;
            }

            if (!distance || !duration || distance <= 0 || duration <= 0) {
                alert('è¯·å…ˆå¡«å†™è·‘æ­¥è·ç¦»å’Œæ—¶é•¿ï¼');
                return;
            }

            // è®¡ç®—é…é€Ÿï¼ˆåˆ†é’Ÿ/å…¬é‡Œï¼‰
            const pace = duration / distance;
            const paceMinutes = Math.floor(pace);
            const paceSeconds = Math.round((pace - paceMinutes) * 60);
            const paceString = `${paceMinutes}:${paceSeconds.toString().padStart(2, '0')}`;

            // ä¼°ç®—å¡è·¯é‡Œæ¶ˆè€—ï¼ˆåŸºäºä½“é‡65kgçš„ç²—ç•¥ä¼°ç®—ï¼‰
            const calories = Math.round(distance * duration * 0.1); // ç®€åŒ–çš„è®¡ç®—å…¬å¼

            // å¡«å……è®¡ç®—ç»“æœ
            document.getElementById('runPace').value = paceString;
            document.getElementById('runCalories').value = calories;

            alert(`è®¡ç®—å®Œæˆï¼\né…é€Ÿï¼š${paceString} åˆ†é’Ÿ/å…¬é‡Œ\nä¼°ç®—æ¶ˆè€—ï¼š${calories} å¡è·¯é‡Œ`);
        }

        // è§£æé…é€Ÿå­—ç¬¦ä¸²ï¼ˆå¦‚ï¼š5:30ï¼‰ä¸ºåˆ†é’Ÿæ•°
        function parsePace(paceString) {
            if (!paceString) return 0;
            const parts = paceString.split(':');
            if (parts.length === 2) {
                const minutes = parseInt(parts[0]) || 0;
                const seconds = parseInt(parts[1]) || 0;
                return minutes + seconds / 60;
            }
            return parseFloat(paceString) || 0;
        }

        // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥æç¤ºï¼ˆå·²ç§»é™¤å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ï¼‰
        function showManualInputHint() {
            alert('ğŸ“‹ è¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•\n\næ­¥éª¤ï¼š\n1. é€‰æ‹©è·‘å‹\n2. è¾“å…¥æ—¥æœŸ\n3. å¡«å†™è·ç¦»å’Œæ—¶é•¿\n4. ç‚¹å‡»"æ·»åŠ è®°å½•"');
        }

        // å·²ç§»é™¤æ‰€æœ‰OCRå’ŒAIè¯†åˆ«åŠŸèƒ½

        // å·²ç§»é™¤AIè¯†åˆ«åŠŸèƒ½ï¼ˆæ›¿æ¢ä¸ºæç¤ºï¼‰
        function performAIRecognition(imageData) {
            alert('ğŸš« AIæ™ºèƒ½è¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚\n\næ­¥éª¤ï¼š\n1. é€‰æ‹©è·‘å‹\n2. è¾“å…¥æ—¥æœŸ\n3. å¡«å†™è·ç¦»å’Œæ—¶é•¿\n4. ç‚¹å‡»"æ·»åŠ è®°å½•"');
        }

        // è°ƒç”¨SiliconFlow APIï¼ˆå·²ç§»é™¤ï¼‰
        function callSiliconFlowAPI(base64Image, modal, timeoutId) {
            alert('ğŸš« AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // å¤„ç†AIè¯†åˆ«ç»“æœï¼ˆå·²ç§»é™¤ï¼‰
        function processAIResult(aiData) {
            alert('ğŸš« AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // æ˜¾ç¤ºAIè¯†åˆ«ç»“æœï¼ˆå·²ç§»é™¤ï¼‰
        function showAIResult(data, rawData) {
            alert('ğŸš« AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // ä»AIè¡¨å•åº”ç”¨æ•°æ®ï¼ˆå·²ç§»é™¤ï¼‰
        function applyAIDataFromForm() {
            alert('ğŸš« AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // ä»AIç»“æœé‡è¯•ä¼ ç»ŸOCRï¼ˆå·²ç§»é™¤ï¼‰
        function retryWithTraditionalOCR() {
            alert('ğŸš« OCRè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // ä»AIç»“æœåˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥ï¼ˆå·²ç§»é™¤ï¼‰
        function showManualInputModalFromAI() {
            alert('ğŸš« AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }
        
        // ç”Ÿæˆæµ‹è¯•æˆªå›¾ï¼ˆå·²ç§»é™¤ï¼‰
        function generateTestScreenshot() {
            alert('ğŸš« æµ‹è¯•åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // æ‰§è¡ŒAIè¯†åˆ«ï¼ˆå·²ç§»é™¤ï¼‰
        function performAIRecognition(imageData) {
            alert('ğŸš« AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // è°ƒç”¨SiliconFlow APIï¼ˆå·²ç§»é™¤ï¼‰
        function callSiliconFlowAPI(base64Image, modal, timeoutId) {
            alert('ğŸš« AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // å¤„ç†AIè¯†åˆ«ç»“æœï¼ˆå·²ç§»é™¤ï¼‰
        function processAIResult(aiData) {
            alert('ğŸš« AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // æ˜¾ç¤ºAIè¯†åˆ«ç»“æœï¼ˆå·²ç§»é™¤ï¼‰
        function showAIResult(data, rawData) {
            alert('ğŸš« AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // ä»AIè¡¨å•åº”ç”¨æ•°æ®ï¼ˆå·²ç§»é™¤ï¼‰
        function applyAIDataFromForm() {
            alert('ğŸš« AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // ä»AIç»“æœé‡è¯•ä¼ ç»ŸOCRï¼ˆå·²ç§»é™¤ï¼‰
        function retryWithTraditionalOCR() {
            alert('ğŸš« OCRè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }

        // ä»AIç»“æœåˆ‡æ¢åˆ°æ‰‹åŠ¨è¾“å…¥ï¼ˆå·²ç§»é™¤ï¼‰
        function showManualInputModalFromAI() {
            alert('ğŸš« AIè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤\n\nè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•ã€‚');
        }
        
        // ç”Ÿæˆæµ‹è¯•è·‘æ­¥æˆªå›¾ - å·²ç§»é™¤
        function generateTestScreenshot() {
            alert('æµ‹è¯•æˆªå›¾åŠŸèƒ½å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•');
        }

        // æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥æ¨¡æ€æ¡†ï¼ˆOCRå¤±è´¥æ—¶ä½¿ç”¨ï¼‰- å·²ç§»é™¤
        function showManualInputModal() {
            alert('OCRè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•');
        }

        // åº”ç”¨æ‰‹åŠ¨è¾“å…¥çš„æ•°æ® - å·²ç§»é™¤
        function applyManualData() {
            alert('OCRè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•');
        }

        // ç›´æ¥æ˜¾ç¤ºæ‰‹åŠ¨è¾“å…¥ç•Œé¢ï¼ˆè·³è¿‡OCRï¼‰- å·²ç§»é™¤
        function directManualInput() {
            alert('OCRè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•');
        }

        // åˆ›å»ºæ¨¡æ€æ¡†
        function createModal(content) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.cssText = `
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0,0,0,.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
            `;
            modal.appendChild(content);
            return modal;
        }

        // å¤„ç†OCRè¯†åˆ«ç»“æœ
        function processOCRResult(text) {
            console.log('OCRè¯†åˆ«ç»“æœï¼š', text);
            
            // æå–è·‘æ­¥æ•°æ®çš„æ­£åˆ™è¡¨è¾¾å¼ - å¢å¼ºç‰ˆæœ¬
            const patterns = {
                // è·ç¦»ï¼šæ”¯æŒå¤šç§æ ¼å¼ï¼ŒåŒ…æ‹¬å°æ•°ç‚¹
                distance: /(\d+\.?\d*)\s*(å…¬é‡Œ|km|åƒç±³|KM|å…¬é‡Œ|km)/gi,
                // æ—¶é•¿ï¼šæ”¯æŒåˆ†é’Ÿã€å°æ—¶åˆ†é’Ÿæ ¼å¼
                duration: /(\d+)\s*(åˆ†é’Ÿ|åˆ†|åˆ†é’Ÿ|min|m)|(\d+):(\d+)\s*(å°æ—¶|æ—¶|h)/gi,
                // é…é€Ÿï¼šæ”¯æŒåˆ†:ç§’æ ¼å¼ï¼Œå¯åŒ…å«åˆ†é’Ÿ/é…é€Ÿç­‰å­—æ ·
                pace: /(\d+):(\d+)(?:\s*(åˆ†é’Ÿ|é…é€Ÿ|pace|min\/km))?/gi,
                // å¡è·¯é‡Œï¼šæ”¯æŒå¤šç§è¡¨è¿°
                calories: /(\d+)\s*(å¡è·¯é‡Œ|å¡|çƒ­é‡|cal|kcal|åƒå¡)/gi,
                // æ—¥æœŸï¼šæ”¯æŒå¤šç§æ—¥æœŸæ ¼å¼
                date: /(\d{4})[å¹´\/-](\d{1,2})[æœˆ\/-](\d{1,2})[æ—¥\s]?|(\d{1,2})[æœˆ\/-](\d{1,2})[æ—¥\s]?|(\d{4})-(\d{2})-(\d{2})/g
            };

            const extractedData = {};
            
            // æå–è·ç¦» - å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ•°å­—
            const distanceMatches = [...text.matchAll(patterns.distance)];
            if (distanceMatches.length > 0) {
                extractedData.distance = parseFloat(distanceMatches[0][1]);
            }
            
            // æå–æ—¶é•¿ - ä¼˜å…ˆåŒ¹é…åˆ†é’Ÿæ ¼å¼ï¼Œå…¶æ¬¡åŒ¹é…å°æ—¶:åˆ†é’Ÿæ ¼å¼
            const durationMatches = [...text.matchAll(patterns.duration)];
            if (durationMatches.length > 0) {
                const match = durationMatches[0];
                if (match[1]) {
                    // çº¯åˆ†é’Ÿæ ¼å¼
                    extractedData.duration = parseInt(match[1]);
                } else if (match[3] && match[4]) {
                    // å°æ—¶:åˆ†é’Ÿæ ¼å¼ï¼Œè½¬æ¢ä¸ºæ€»åˆ†é’Ÿæ•°
                    const hours = parseInt(match[3]) || 0;
                    const minutes = parseInt(match[4]) || 0;
                    extractedData.duration = hours * 60 + minutes;
                }
            }
            
            // æå–é…é€Ÿ - å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„é…é€Ÿ
            const paceMatches = [...text.matchAll(patterns.pace)];
            if (paceMatches.length > 0) {
                const match = paceMatches[0];
                extractedData.pace = `${match[1]}:${match[2].padStart(2, '0')}`;
            }
            
            // æå–å¡è·¯é‡Œ - å–ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ•°å­—
            const caloriesMatches = [...text.matchAll(patterns.calories)];
            if (caloriesMatches.length > 0) {
                extractedData.calories = parseInt(caloriesMatches[0][1]);
            }
            
            // æå–æ—¥æœŸ - æ”¯æŒå¤šç§æ ¼å¼
            const dateMatches = [...text.matchAll(patterns.date)];
            if (dateMatches.length > 0) {
                const match = dateMatches[0];
                let year, month, day;
                
                if (match[1] && match[2] && match[3]) {
                    // 2024å¹´1æœˆ15æ—¥ æˆ– 2024-1-15 æ ¼å¼
                    year = match[1];
                    month = match[2].padStart(2, '0');
                    day = match[3].padStart(2, '0');
                } else if (match[4] && match[5]) {
                    // 1æœˆ15æ—¥ æ ¼å¼ï¼Œéœ€è¦è¡¥å…¨å¹´ä»½
                    year = new Date().getFullYear();
                    month = match[4].padStart(2, '0');
                    day = match[5].padStart(2, '0');
                } else if (match[6] && match[7] && match[8]) {
                    // 2024-01-15 æ ¼å¼
                    year = match[6];
                    month = match[7];
                    day = match[8];
                }
                
                if (year && month && day) {
                    extractedData.date = `${year}-${month}-${day}`;
                }
            }

            // å¦‚æœæ²¡æœ‰è¯†åˆ«åˆ°æ—¥æœŸï¼Œä½¿ç”¨å½“å‰æ—¥æœŸä½œä¸ºé»˜è®¤å€¼
            if (!extractedData.date) {
                extractedData.date = new Date().toISOString().split('T')[0];
            }

            showOCRResult(extractedData, text);
        }

        // æ˜¾ç¤ºOCRè¯†åˆ«ç»“æœ - å·²ç§»é™¤
        function showOCRResult(data, rawText) {
            alert('OCRè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•');
        }

        // å…³é—­OCRç»“æœå¼¹çª— - å·²ç§»é™¤
        function closeOCRModal() {
            // åŠŸèƒ½å·²ç§»é™¤
        }

        // ä»OCRè¡¨å•åº”ç”¨æ•°æ® - å·²ç§»é™¤
        function applyOCRDataFromForm() {
            alert('OCRè¯†åˆ«åŠŸèƒ½å·²ç§»é™¤ï¼Œè¯·ä½¿ç”¨å·¦ä¾§è¡¨å•æ‰‹åŠ¨æ·»åŠ è·‘æ­¥è®°å½•');
        }

        // æ·»åŠ è·‘æ­¥è®°å½•
        function addRecord() {
            const runnerId = document.getElementById('runnerSelect').value;
            const date = document.getElementById('runDate').value;
            const distance = parseFloat(document.getElementById('runDistance').value);
            const duration = parseFloat(document.getElementById('runDuration').value);
            const pace = document.getElementById('runPace').value;
            const calories = parseInt(document.getElementById('runCalories').value) || 0;

            if (!runnerId || !date || !distance || distance <= 0) {
                alert('è¯·å¡«å†™å®Œæ•´çš„è·‘æ­¥è®°å½•ä¿¡æ¯ï¼ˆè‡³å°‘åŒ…å«è·‘å‹ã€æ—¥æœŸã€è·ç¦»ï¼‰ï¼');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰åŒä¸€å¤©çš„è®°å½•
            const existingRecord = records.find(r => 
                r.runnerId == runnerId && r.date === date
            );

            const recordData = {
                id: existingRecord ? existingRecord.id : Date.now(),
                runnerId: parseInt(runnerId),
                date: date,
                distance: distance,
                duration: duration || null,
                pace: pace || null,
                calories: calories || null
            };

            if (existingRecord) {
                if (confirm('è¯¥è·‘å‹ä»Šå¤©å·²æœ‰è·‘æ­¥è®°å½•ï¼Œæ˜¯å¦æ›´æ–°è®°å½•ï¼Ÿ')) {
                    const index = records.findIndex(r => r.id === existingRecord.id);
                    records[index] = recordData;
                } else {
                    return;
                }
            } else {
                records.push(recordData);
            }

            localStorage.setItem('runningRecords', JSON.stringify(records));

            // åŒæ­¥åˆ°äº‘ç«¯
            if (CLOUD_SYNC_CONFIG.enableSync && navigator.onLine) {
                (async () => {
                    try {
                        await syncToCloud();
                        // åŒæ­¥æˆåŠŸåç«‹å³æ‹‰å–æœ€æ–°æ•°æ®
                        await syncFromCloud();
                        updateAllUI();
                    } catch (error) {
                        console.error('åŒæ­¥å¤±è´¥:', error);
                    }
                })();
            } else if (CLOUD_SYNC_CONFIG.enableSync) {
                // ç¦»çº¿æ—¶æ·»åŠ åˆ°å¾…åŒæ­¥é˜Ÿåˆ—
                syncStatus.pendingSync.push({
                    type: 'addRecord', 
                    data: recordData,
                    timestamp: Date.now()
                });
                localStorage.setItem('pendingSyncQueue', JSON.stringify(syncStatus.pendingSync));
            }

            // æ¸…ç©ºè¾“å…¥
            document.getElementById('runDistance').value = '';
            document.getElementById('runDuration').value = '';
            document.getElementById('runPace').value = '';
            document.getElementById('runCalories').value = '';

            // æ›´æ–°ç•Œé¢
            updateRunnerList();
            updateRecordsTable();
            updateSummaryStats();

            alert('è·‘æ­¥è®°å½•æ·»åŠ æˆåŠŸï¼');
        }

        // è·å–å‘¨å¼€å§‹æ—¥æœŸ
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1); // è°ƒæ•´ä¸ºå‘¨ä¸€å¼€å§‹
            return new Date(d.setDate(diff));
        }

        // è·å–å‘¨ç»“æŸæ—¥æœŸ
        function getWeekEnd(date) {
            const weekStart = getWeekStart(date);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            return weekEnd;
        }

        // è·å–è·‘å‹æœ¬å‘¨ç»Ÿè®¡
        function getRunnerWeekStats(runnerId, weekStart) {
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            const weekRecords = records.filter(r => {
                const recordDate = new Date(r.date);
                return r.runnerId == runnerId && 
                       recordDate >= weekStart && 
                       recordDate <= weekEnd;
            });

            const totalDistance = weekRecords.reduce((sum, r) => sum + r.distance, 0);
            const runDays = weekRecords.length;
            const qualifiedRuns = weekRecords.filter(r => r.distance >= 5).length;
            
            // è®¡ç®—å¹³å‡é…é€Ÿ
            const paceRecords = weekRecords.filter(r => r.pace);
            let avgPace = null;
            if (paceRecords.length > 0) {
                const totalPaceMinutes = paceRecords.reduce((sum, r) => {
                    return sum + parsePace(r.pace);
                }, 0);
                const avgPaceMinutes = totalPaceMinutes / paceRecords.length;
                const avgMinutes = Math.floor(avgPaceMinutes);
                const avgSeconds = Math.round((avgPaceMinutes - avgMinutes) * 60);
                avgPace = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            }
            
            // è®¡ç®—æ€»æ¶ˆè€—å¡è·¯é‡Œ
            const totalCalories = weekRecords.reduce((sum, r) => sum + (r.calories || 0), 0);

            return {
                totalDistance: totalDistance,
                runDays: runDays,
                qualifiedRuns: qualifiedRuns,
                records: weekRecords,
                avgPace: avgPace,
                totalCalories: totalCalories > 0 ? totalCalories : null
            };
        }

        // æ›´æ–°è·‘å‹åˆ—è¡¨
        function updateRunnerList() {
            const container = document.getElementById('runnerList');
            container.innerHTML = '';

            // æ›´æ–°æ‰‹åŠ¨æ·»åŠ åŒºåŸŸçš„è·‘å‹é€‰æ‹©
            const runnerSelect = document.getElementById('runnerSelect');
            runnerSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è·‘å‹</option>';
            
            // OCRåŒºåŸŸçš„è·‘å‹é€‰æ‹©å·²ç§»é™¤
            // const runnerSelectOCR = document.getElementById('runnerSelectOCR');
            // runnerSelectOCR.innerHTML = '<option value="">è¯·é€‰æ‹©è·‘å‹</option>';

            if (runners.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">æš‚æ— è·‘å‹ï¼Œè¯·å…ˆæ·»åŠ è·‘å‹</p>';
                return;
            }

            // å¡«å……è·‘å‹é€‰æ‹©ä¸‹æ‹‰æ¡†
            runners.forEach(runner => {
                const option1 = document.createElement('option');
                option1.value = runner.id;
                option1.textContent = runner.name;
                runnerSelect.appendChild(option1);
                
                // OCRåŒºåŸŸçš„è·‘å‹é€‰æ‹©å·²ç§»é™¤
                // const option2 = document.createElement('option');
                // option2.value = runner.id;
                // option2.textContent = runner.name;
                // runnerSelectOCR.appendChild(option2);
            });

            const weekStart = getWeekStart(new Date());

            runners.forEach(runner => {
                const stats = getRunnerWeekStats(runner.id, weekStart);
                const isComplete = stats.qualifiedRuns >= 3 && stats.totalDistance >= runner.targetDistance;
                const isWarning = stats.qualifiedRuns < 3 || stats.totalDistance < runner.targetDistance;

                const card = document.createElement('div');
                card.className = `runner-card ${isComplete ? '' : 'incomplete'} ${isWarning ? 'warning' : ''}`;

                const progressPercent = Math.min((stats.totalDistance / runner.targetDistance) * 100, 100);

                card.innerHTML = `
                    <div class="runner-name">${runner.name}</div>
                    <div class="runner-target">ç›®æ ‡ï¼š${runner.targetDistance}å…¬é‡Œ/å‘¨ | å·²å®Œæˆï¼š${stats.totalDistance.toFixed(1)}å…¬é‡Œ</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%">
                            ${progressPercent.toFixed(0)}%
                        </div>
                    </div>
                    <div style="font-size: 0.9em; margin-bottom: 10px;">
                        æœ¬å‘¨è·‘æ­¥ï¼š${stats.runDays}æ¬¡ | è¾¾æ ‡ï¼š${stats.qualifiedRuns}æ¬¡
                        ${stats.avgPace ? `| å¹³å‡é…é€Ÿï¼š${stats.avgPace}` : ''}
                        ${stats.totalCalories ? `| æ€»æ¶ˆè€—ï¼š${stats.totalCalories}å¡` : ''}
                    </div>
                    <div class="week-stats">
                        ${getWeekDaysHTML(stats.records, weekStart)}
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // è·å–å‘¨æ˜¾ç¤ºHTML
        function getWeekDaysHTML(records, weekStart) {
            const days = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
            let html = '';

            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(weekStart);
                currentDate.setDate(weekStart.getDate() + i);
                const dateStr = currentDate.toISOString().split('T')[0];
                
                const dayRecord = records.find(r => r.date === dateStr);
                const hasRecord = !!dayRecord;
                const isQualified = hasRecord && dayRecord.distance >= 5;

                html += `
                    <div class="day-stat ${hasRecord ? (isQualified ? 'completed' : 'incomplete') : ''}">
                        <div>${days[i]}</div>
                        ${hasRecord ? `<div>${dayRecord.distance}km</div>` : '<div>-</div>'}
                        ${hasRecord && dayRecord.pace ? `<div>${dayRecord.pace}</div>` : ''}
                    </div>
                `;
            }

            return html;
        }

        // æ›´æ–°è®°å½•è¡¨æ ¼
        function updateRecordsTable() {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';

            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">æš‚æ— è·‘æ­¥è®°å½•</td></tr>';
                return;
            }

            // æŒ‰æ—¥æœŸå€’åºæ’åˆ—
            const sortedRecords = [...records].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedRecords.forEach(record => {
                const runner = runners.find(r => r.id == record.runnerId);
                if (!runner) return;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${runner.name}</td>
                    <td>${record.date}</td>
                    <td>${record.distance}</td>
                    <td>${record.duration || '-'}</td>
                    <td>${record.pace || '-'}</td>
                    <td>${record.calories || '-'}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" 
                                onclick="deleteRecord(${record.id})">åˆ é™¤</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(recordId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                records = records.filter(r => r.id !== recordId);
                localStorage.setItem('runningRecords', JSON.stringify(records));
                
                updateRunnerList();
                updateRecordsTable();
                updateSummaryStats();
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
        function updateSummaryStats() {
            const container = document.getElementById('summaryStats');
            const penaltyContainer = document.getElementById('penaltyInfo');
            
            const weekStart = getWeekStart(new Date());
            let totalRunners = runners.length;
            let completedRunners = 0;
            let totalPenalties = 0;
            let completedDistance = 0;
            let totalDuration = 0;
            let totalCalories = 0;
            let avgPaceRecords = [];

            runners.forEach(runner => {
                const stats = getRunnerWeekStats(runner.id, weekStart);
                const isComplete = stats.qualifiedRuns >= 3 && stats.totalDistance >= runner.targetDistance;
                
                if (isComplete) {
                    completedRunners++;
                } else {
                    totalPenalties += 500;
                }
                
                completedDistance += stats.totalDistance;
                totalDuration += stats.records.reduce((sum, r) => sum + (r.duration || 0), 0);
                totalCalories += stats.totalCalories || 0;
                
                // æ”¶é›†æ‰€æœ‰é…é€Ÿæ•°æ®
                stats.records.forEach(r => {
                    if (r.pace) {
                        avgPaceRecords.push(parsePace(r.pace));
                    }
                });
            });

            const rewardPerPerson = completedRunners > 0 ? totalPenalties / completedRunners : 0;
            
            // è®¡ç®—å¹³å‡é…é€Ÿ
            let avgPace = null;
            if (avgPaceRecords.length > 0) {
                const avgPaceMinutes = avgPaceRecords.reduce((sum, pace) => sum + pace, 0) / avgPaceRecords.length;
                const avgMinutes = Math.floor(avgPaceMinutes);
                const avgSeconds = Math.round((avgPaceMinutes - avgMinutes) * 60);
                avgPace = `${avgMinutes}:${avgSeconds.toString().padStart(2, '0')}`;
            }

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalRunners}</div>
                    <div class="stat-label">æ€»è·‘å‹æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${completedRunners}</div>
                    <div class="stat-label">æœ¬å‘¨è¾¾æ ‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${completedDistance.toFixed(1)}</div>
                    <div class="stat-label">æœ¬å‘¨æ€»é‡Œç¨‹(km)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${Math.round(totalDuration)}</div>
                    <div class="stat-label">æœ¬å‘¨æ€»æ—¶é•¿(åˆ†)</div>
                </div>
                ${avgPace ? `
                <div class="stat-card">
                    <div class="stat-number">${avgPace}</div>
                    <div class="stat-label">å¹³å‡é…é€Ÿ</div>
                </div>
                ` : ''}
                ${totalCalories > 0 ? `
                <div class="stat-card">
                    <div class="stat-number">${Math.round(totalCalories)}</div>
                    <div class="stat-label">æ€»æ¶ˆè€—(å¡)</div>
                </div>
                ` : ''}
                <div class="stat-card">
                    <div class="stat-number">${totalPenalties}</div>
                    <div class="stat-label">æœ¬å‘¨ç½šæ¬¾æ€»é¢(å…ƒ)</div>
                </div>
            `;

            if (totalPenalties > 0 && completedRunners > 0) {
                penaltyContainer.innerHTML = `
                    <h3>ğŸ† æœ¬å‘¨å¥–åŠ±åˆ†é…</h3>
                    <p>è¾¾æ ‡è·‘å‹æ¯äººå¯è·å¾—å¥–åŠ±ï¼š${rewardPerPerson.toFixed(2)}å…ƒ</p>
                    <p>æœªè¾¾æ ‡è·‘å‹éœ€è¦ç¼´çº³ç½šæ¬¾ï¼š500å…ƒ</p>
                `;
            } else if (totalPenalties > 0) {
                penaltyContainer.innerHTML = `
                    <h3>âš ï¸ æœ¬å‘¨æ— è¾¾æ ‡è·‘å‹</h3>
                    <p>ç½šæ¬¾æ€»é¢ï¼š${totalPenalties}å…ƒå°†ç´¯ç§¯åˆ°ä¸‹å‘¨</p>
                `;
            } else {
                penaltyContainer.innerHTML = `
                    <h3>ğŸ‰ æœ¬å‘¨å…¨å‘˜è¾¾æ ‡ï¼</h3>
                    <p>æ‰€æœ‰è·‘å‹éƒ½å®Œæˆäº†æœ¬å‘¨ç›®æ ‡ï¼Œå¤ªæ£’äº†ï¼</p>
                `;
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const data = {
                runners: runners,
                records: records,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è·‘æ­¥æ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateWeekHistory() {
            const weekStart = getWeekStart(new Date());
            weekStart.setDate(weekStart.getDate() + (currentWeekOffset * 7));
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            // æ›´æ–°å‘¨æ˜¾ç¤º
            const weekDisplay = document.getElementById('currentWeekDisplay');
            const weekRange = `${weekStart.getMonth() + 1}æœˆ${weekStart.getDate()}æ—¥ - ${weekEnd.getMonth() + 1}æœˆ${weekEnd.getDate()}æ—¥`;
            const yearDisplay = weekStart.getFullYear() !== new Date().getFullYear() ? `${weekStart.getFullYear()}å¹´` : '';
            weekDisplay.innerHTML = `<strong>${yearDisplay}${weekRange}</strong>`;
            
            // è·å–æœ¬å‘¨ç»Ÿè®¡
            const weekStats = [];
            let totalDistance = 0;
            let totalRuns = 0;
            let qualifiedRunners = 0;
            
            runners.forEach(runner => {
                const stats = getRunnerWeekStats(runner.id, weekStart);
                const isComplete = stats.qualifiedRuns >= 3 && stats.totalDistance >= runner.targetDistance;
                
                weekStats.push({
                    runner: runner,
                    stats: stats,
                    isComplete: isComplete
                });
                
                totalDistance += stats.totalDistance;
                totalRuns += stats.records.length;
                if (isComplete) qualifiedRunners++;
            });
            
            // æ›´æ–°ç»Ÿè®¡æ¦‚è§ˆ
            updateWeekHistoryStats(totalDistance, totalRuns, qualifiedRunners, runners.length);
            
            // æ›´æ–°è¯¦ç»†è®°å½•
            updateWeekHistoryDetails(weekStats);
        }
        
        // æ›´æ–°å†å²è®°å½•ç»Ÿè®¡æ¦‚è§ˆ
        function updateWeekHistoryStats(totalDistance, totalRuns, qualifiedRunners, totalRunners) {
            const container = document.getElementById('weekHistoryStats');
            
            container.innerHTML = `
                <div class="week-history-card">
                    <h4>æ€»è·‘å‹æ•°</h4>
                    <div class="stat-value">${totalRunners}</div>
                    <div class="stat-label">ä½è·‘å‹</div>
                </div>
                <div class="week-history-card">
                    <h4>è¾¾æ ‡äººæ•°</h4>
                    <div class="stat-value">${qualifiedRunners}</div>
                    <div class="stat-label">ä½è¾¾æ ‡</div>
                </div>
                <div class="week-history-card">
                    <h4>æ€»è·‘æ­¥æ¬¡æ•°</h4>
                    <div class="stat-value">${totalRuns}</div>
                    <div class="stat-label">æ¬¡è·‘æ­¥</div>
                </div>
                <div class="week-history-card">
                    <h4>æ€»è·‘æ­¥è·ç¦»</h4>
                    <div class="stat-value">${totalDistance.toFixed(1)}</div>
                    <div class="stat-label">å…¬é‡Œ</div>
                </div>
            `;
        }
        
        // æ›´æ–°å†å²è®°å½•è¯¦ç»†ä¿¡æ¯
        function updateWeekHistoryDetails(weekStats) {
            const container = document.getElementById('weekHistoryDetails');
            
            if (weekStats.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">æš‚æ— è·‘å‹æ•°æ®</div>';
                return;
            }
            
            // æŒ‰è¾¾æ ‡æƒ…å†µæ’åº
            weekStats.sort((a, b) => {
                if (a.isComplete && !b.isComplete) return -1;
                if (!a.isComplete && b.isComplete) return 1;
                return b.stats.totalDistance - a.stats.totalDistance;
            });
            
            container.innerHTML = weekStats.map(item => {
                const statusClass = item.isComplete ? 'status-complete' : 'status-incomplete';
                const statusText = item.isComplete ? 'âœ… è¾¾æ ‡' : 'âŒ æœªè¾¾æ ‡';
                const completionRate = Math.min((item.stats.totalDistance / item.runner.targetDistance * 100), 100).toFixed(1);
                
                return `
                    <div class="week-history-runner">
                        <div class="week-history-runner-name">
                            ${item.runner.name}
                            <span class="${statusClass}" style="margin-left: 10px;">${statusText}</span>
                        </div>
                        <div class="week-history-runner-stats">
                            <div class="week-history-runner-stat">
                                <div class="value">${item.stats.totalDistance.toFixed(1)}</div>
                                <div class="label">æ€»è·ç¦»(km)</div>
                            </div>
                            <div class="week-history-runner-stat">
                                <div class="value">${item.stats.runDays}</div>
                                <div class="label">è·‘æ­¥å¤©æ•°</div>
                            </div>
                            <div class="week-history-runner-stat">
                                <div class="value">${item.stats.qualifiedRuns}</div>
                                <div class="label">è¾¾æ ‡æ¬¡æ•°</div>
                            </div>
                            <div class="week-history-runner-stat">
                                <div class="value">${completionRate}%</div>
                                <div class="label">å®Œæˆç‡</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // åˆ‡æ¢å‘¨
        function changeWeek(direction) {
            currentWeekOffset += direction;
            updateWeekHistory();
        }
        
        // è¿”å›æœ¬å‘¨
        function goToCurrentWeek() {
            currentWeekOffset = 0;
            updateWeekHistory();
        }

        // æ·»åŠ å¯¼å‡ºæŒ‰é’®
        document.addEventListener('DOMContentLoaded', function() {
            const header = document.querySelector('.header');
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn btn-warning';
            exportBtn.textContent = 'å¯¼å‡ºæ•°æ®';
            exportBtn.onclick = exportData;
            exportBtn.style.cssText = 'position: absolute; top: 20px; right: 20px;';
            header.appendChild(exportBtn);
        });

        // å¾®ä¿¡æµè§ˆå™¨æ£€æµ‹å’Œé€‚é…
        function detectWeChatBrowser() {
            const ua = navigator.userAgent.toLowerCase();
            const isWeChat = /micromessenger/i.test(ua);
            
            if (isWeChat) {
                console.log('æ£€æµ‹åˆ°å¾®ä¿¡æµè§ˆå™¨ï¼Œåº”ç”¨å¾®ä¿¡ä¸“ç”¨ä¼˜åŒ–');
                
                // æ·»åŠ å¾®ä¿¡ä¼˜åŒ–ç±»
                document.body.classList.add('wechat-optimized');
                document.documentElement.classList.add('wechat-safe-area');
                
                // å¾®ä¿¡æµè§ˆå™¨æ»šåŠ¨ä¼˜åŒ–
                document.querySelector('.container').classList.add('wechat-scroll');
                
                // ä¸ºæ‰€æœ‰æŒ‰é’®å’Œå¯ç‚¹å‡»å…ƒç´ æ·»åŠ å¾®ä¿¡ç‚¹å‡»ä¼˜åŒ–
                const clickableElements = document.querySelectorAll('.btn, .runner-card, .day-stat, .week-history-card');
                clickableElements.forEach(element => {
                    element.classList.add('wechat-tap');
                });
                
                // å¾®ä¿¡æµè§ˆå™¨å­—ä½“ä¼˜åŒ–
                document.body.style.fontFamily = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"';
                
                // å¾®ä¿¡æµè§ˆå™¨è§†å£é€‚é…
                const viewport = document.querySelector('meta[name="viewport"]');
                if (viewport) {
                    viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
                }
                
                // å¾®ä¿¡æµè§ˆå™¨å®‰å…¨åŒºåŸŸé€‚é…
                const safeAreaStyle = document.createElement('style');
                safeAreaStyle.textContent = `
                    .wechat-safe-area {
                        padding-top: constant(safe-area-inset-top);
                        padding-top: env(safe-area-inset-top);
                        padding-bottom: constant(safe-area-inset-bottom);
                        padding-bottom: env(safe-area-inset-bottom);
                        padding-left: constant(safe-area-inset-left);
                        padding-left: env(safe-area-inset-left);
                        padding-right: constant(safe-area-inset-right);
                        padding-right: env(safe-area-inset-right);
                    }
                `;
                document.head.appendChild(safeAreaStyle);
                
                // å¾®ä¿¡æµè§ˆå™¨è¾“å…¥æ¡†ä¼˜åŒ–
                const inputs = document.querySelectorAll('input, select');
                inputs.forEach(input => {
                    input.style.fontSize = '16px'; // é˜²æ­¢å¾®ä¿¡æµè§ˆå™¨ç¼©æ”¾
                    input.addEventListener('focus', function() {
                        document.body.style.position = 'fixed';
                        document.body.style.width = '100%';
                    });
                    input.addEventListener('blur', function() {
                        document.body.style.position = '';
                        document.body.style.width = '';
                    });
                });
                
                console.log('å¾®ä¿¡æµè§ˆå™¨ä¼˜åŒ–å·²å®Œæˆ');
            }
            
            return isWeChat;
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œå¾®ä¿¡æ£€æµ‹
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(detectWeChatBrowser, 100);
            
            // åˆå§‹åŒ–å®æ—¶åŒæ­¥ç®¡ç†å™¨
            realtimeSyncManager = new RealtimeSyncManager();
            
            // å¤„ç†å¾…åŒæ­¥é˜Ÿåˆ—
            if (syncStatus.pendingSync.length > 0 && navigator.onLine && CLOUD_SYNC_CONFIG.enableSync) {
                setTimeout(processPendingSync, 2000); // 2ç§’åå¤„ç†å¾…åŒæ­¥é˜Ÿåˆ—
            }
            
            // å¯åŠ¨å®æ—¶åŒæ­¥
            if (CLOUD_SYNC_CONFIG.enableSync) {
                setTimeout(() => {
                    realtimeSyncManager.startRealtimeSync();
                }, 3000); // 3ç§’åå¯åŠ¨å®æ—¶åŒæ­¥
            }
        });
        
        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°é€‚é…
        window.addEventListener('resize', function() {
            if (document.body.classList.contains('wechat-optimized')) {
                detectWeChatBrowser();
            }
        });
    </script>
</body>
</html>